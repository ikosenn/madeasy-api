#!/usr/bin/env python3
import os
import sys
import click

from madeasy.config import settings
from sarge import run

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


def _fail_loudly(sarge_obj):
    """
    Throw an exit(0) error when the return code from sarge runs command is
    not zero
    """
    if sarge_obj.returncode:
        sys.exit(1)


def _manage(command, args=''):
    """
    A helper that simplifies Django management command invocations
    """
    p = run('{}/manage.py {} {}'.format(BASE_DIR, command, args))
    _fail_loudly(p)


def _psql(query, no_sudo=False, is_file=False):
    """
    Dev only - used by the setup function below
    """
    sudo = 'sudo -u postgres'
    if no_sudo:
        sudo = ''

    if is_file:
        p = run('{} psql < {}'.format(sudo, query))
    else:
        p = run('{} psql -c "{}"'.format(sudo, query))

    _fail_loudly(p)


@click.command()
def test(*args, **kwargs):
    """
    Default command used to run tests in dev and continous integration
    """
    process_one = run('python setup.py check')
    _fail_loudly(process_one)
    process_two = run('tox -c tox.ini')  # Does not force env recreation
    _fail_loudly(process_two)


@click.command()
def test_with_clean_db(*args, **kwargs):
    """
    Recreate the test database before testing to reflect schema changes
    """
    p = run('py.test --create-db')
    _fail_loudly(p)


@click.command()
def reset(*args, **kwargs):
    """
    Drop and recreate the DB but do not load data. Migrations should run
    """
    no_sudo = True if 'no-sudo' in args else False

    db_name = settings.DATABASES.get('default').get('NAME')
    db_user = settings.DATABASES.get('default').get('USER')
    db_pass = settings.DATABASES.get('default').get('PASSWORD')

    _psql("DROP DATABASE IF EXISTS {}".format(db_name), no_sudo)
    _psql("DROP DATABASE IF EXISTS test_{}".format(db_name), no_sudo)
    _psql("DROP USER IF EXISTS {}".format(db_user), no_sudo)
    _psql("CREATE USER {0} WITH SUPERUSER CREATEDB "
          "CREATEROLE LOGIN PASSWORD '{1}'".format(db_user, db_pass), no_sudo)
    _psql('CREATE DATABASE {}'.format(db_name), no_sudo)

    _manage('migrate')


@click.group(chain=True, invoke_without_command=True)
@click.pass_context
def setup(ctx):
    """
    Delete the development database, recreate it, load data
    """
    ctx.invoke(reset)


@click.command()
def server():
    """
    Run a development server, listen on port 8092
    """
    _manage('runserver', args='8092')


@click.group()
def cli():
    """
    Development helpers for the EMR project

    These utilities help with testing, loading of data, database resets etc
    """
    pass


cli.add_command(test)
cli.add_command(test_with_clean_db)
cli.add_command(reset)
cli.add_command(setup)
cli.add_command(server)


if __name__ == '__main__':
    cli()
